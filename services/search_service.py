import asyncio
from ddgs import DDGS
from app.logger import logger


async def search_duckduckgo(query: str) -> list[str]:
    """
    Выполняет асинхронный поиск в DuckDuckGo по заданному запросу.

    Функция предназначена для безопасного использования в асинхронном коде.
    Поскольку библиотека `ddgs` предоставляет только синхронный API,
    поиск оборачивается в `run_in_executor`, чтобы не блокировать
    основной event loop asyncio.

    В процессе работы:
    - создаётся экземпляр клиента DDGS;
    - синхронный метод поиска выполняется в отдельном потоке;
    - результаты преобразуются в человекочитаемый список строк;
    - все ключевые этапы логируются.

    В случае ошибки функция не выбрасывает исключение наружу,
    а возвращает список с текстом ошибки.

    Args:
        query (str): Поисковый запрос, введённый пользователем.

    Returns:
        list[str]: Список строк с результатами поиска.
        Каждый элемент содержит заголовок и ссылку,
        либо сообщение об ошибке / отсутствии результатов.
    """
    # Создаём экземпляр клиента DuckDuckGo Search
    ddgs = DDGS()

    # Получаем текущий асинхронный event loop
    loop = asyncio.get_running_loop()

    # Логируем запуск поискового запроса
    logger.info("Запуск поиска через DDGS (Dux Distributed Global Search)...")

    def search_ddgs():  # pragma: no cover
        """
        Синхронная функция-обёртка для вызова DDGS().text().

        Выделена в отдельную функцию, чтобы передать её
        в executor и выполнить в другом потоке.

        pragma: no cover — исключает функцию из покрытия тестами,
        так как она используется только как внутренняя обёртка.
        """
        return ddgs.text(query, region="wt-wt", max_results=5)

    try:
        # Выполняем синхронный поиск в пуле потоков,
        # чтобы не блокировать asyncio event loop
        results = await asyncio.wait_for(
            loop.run_in_executor(None, search_ddgs),  # type: ignore
            timeout=10  # таймаут в секундах
        )
    except Exception as e:
        # Логируем ошибку поиска
        logger.warning(
            "Ошибка поиска через DDGS (Dux Distributed Global Search)\n%s", e
        )
        # Возвращаем список с текстом ошибки
        return ["Произошла ошибка при поиске. Попробуйте позже."]

    # Список для форматированных результатов поиска
    output = []

    # Проверяем, вернул ли поиск какие-либо результаты
    if results:
        for item in results:
            # duckduckgo-search возвращает словари,
            # содержащие ключи 'title' и 'href'
            title = item.get("title")
            link = item.get("href")

            # Добавляем результат только если есть и заголовок, и ссылка
            if title and link:
                output.append(f"{title}\n{link}")
    else:
        # Если результатов нет — добавляем соответствующее сообщение
        output.append("Ничего не найдено.")

    # Логируем успешное завершение поиска
    logger.info("Поиска через DDGS (Dux Distributed Global Search) завершён")

    # Возвращаем список результатов пользователю
    return output


# Пример ручного запуска модуля для отладки
async def main():
    """
    Точка входа для локального тестирования модуля поиска.

    Запрашивает поисковый запрос у пользователя через стандартный ввод,
    выполняет поиск в DuckDuckGo и выводит результаты в консоль.

    Используется исключительно для отладки и ручной проверки работы
    функции `search_duckduckgo`.
    """
    # Запрашиваем поисковый запрос у пользователя
    query = input("Введите запрос для поиска:")

    # Выполняем асинхронный поиск
    res = await search_duckduckgo(query)

    # Выводим каждый результат в консоль
    for r in res:
        print(r, "\n")


if __name__ == "__main__":  # pragma: no cover
    # Запуск асинхронной точки входа при прямом запуске файла
    asyncio.run(main())
