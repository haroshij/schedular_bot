import pytest
from utils.search_utils import validate_search_query


# -------------------------------------------------------------------
# –¢–µ—Å—Ç—ã –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
# -------------------------------------------------------------------


@pytest.mark.parametrize(
    "query",
    [
        "hi",  # –ø—Ä–æ—Å—Ç–æ–µ —Å–ª–æ–≤–æ
        "hello world",  # –¥–≤–∞ —Å–ª–æ–≤–∞ —Å –ø—Ä–æ–±–µ–ª–æ–º
        "python-telegram bot",  # —Å–ª–æ–≤–æ —Å –¥–µ—Ñ–∏—Å–æ–º –∏ –ø—Ä–æ–±–µ–ª–æ–º
        "—á—Ç–æ —Ç–∞–∫–æ–µ async",  # —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç + –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ
        "test, with punctuation!",  # —Ç–µ–∫—Å—Ç —Å –ø—É–Ω–∫—Ç—É–∞—Ü–∏–µ–π
        "numbers 123",  # —Ç–µ–∫—Å—Ç —Å —Ü–∏—Ñ—Ä–∞–º–∏
        "dots.and,commas",  # —Ç–µ–∫—Å—Ç —Å —Ç–æ—á–∫–∞–º–∏ –∏ –∑–∞–ø—è—Ç—ã–º–∏
        "A" * 200,  # –≥—Ä–∞–Ω–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –¥–ª–∏–Ω–µ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ)
    ],
)
def test_validate_search_query_valid(query):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ validate_search_query –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

    –§—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å True –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ:
    - —Å–æ–¥–µ—Ä–∂–∞—Ç –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã –∏ –±–∞–∑–æ–≤—É—é –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é
    - –∏–º–µ—é—Ç –¥–ª–∏–Ω—É –æ—Ç 2 –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤
    """
    assert validate_search_query(query) is True


# -------------------------------------------------------------------
# –¢–µ—Å—Ç—ã –Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
# -------------------------------------------------------------------


@pytest.mark.parametrize(
    "query",
    [
        "",  # –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
        "a",  # —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è (–º–µ–Ω—å—à–µ 2 —Å–∏–º–≤–æ–ª–æ–≤)
        " ",  # —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª
        "\n",  # —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏
        "üî•",  # emoji (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Å–∏–º–≤–æ–ª)
        "<script>",  # HTML-—Ç–µ–≥–∏ (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã)
        "SELECT * FROM",  # SQL-–ø–æ–¥–æ–±–Ω—ã–π –≤–≤–æ–¥ (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π)
        "A" * 201,  # —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (>200 —Å–∏–º–≤–æ–ª–æ–≤)
    ],
)
def test_validate_search_query_invalid(query):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ validate_search_query –¥–ª—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

    –§—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å False –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ:
    - —Å–æ–¥–µ—Ä–∂–∞—Ç –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (emoji, HTML)
    - —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ (<2 —Å–∏–º–≤–æ–ª–æ–≤) –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ (>200 —Å–∏–º–≤–æ–ª–æ–≤)
    - —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã –∏–ª–∏ —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–∏–º–≤–æ–ª—ã
    """
    assert validate_search_query(query) is False


# -------------------------------------------------------------------
# –¢–µ—Å—Ç –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ None
# -------------------------------------------------------------------


def test_validate_search_query_none_raises():
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ validate_search_query –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ None.

    –§—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å TypeError, —Ç–∞–∫ –∫–∞–∫ None –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–æ–ø—É—Å—Ç–∏–º—ã–º —Ç–∏–ø–æ–º —Å—Ç—Ä–æ–∫–∏.
    """
    with pytest.raises(TypeError):
        validate_search_query(None)  # type: ignore
