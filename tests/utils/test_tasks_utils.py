import pytest
from datetime import datetime, timezone, timedelta
from utils.tasks_utils import parse_datetime, format_task_date, format_task, parse_and_validate_datetime
from constants.time_constants import MOSCOW_TZ, RU_DAYS, RU_MONTHS
from freezegun import freeze_time


# -------------------------------------------------------------------
# –¢–µ—Å—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ parse_datetime
# -------------------------------------------------------------------
@freeze_time("2026-02-09 12:00:00", tz_offset=3)
@pytest.mark.parametrize(
    "text,expected",
    [
        ("2026-02-10 15:30", datetime(2026, 2, 10, 15, 30)),
        ("—Å–µ–≥–æ–¥–Ω—è 14:45", datetime(2026, 2, 9, 14, 45, tzinfo=MOSCOW_TZ)),
        ("–∑–∞–≤—Ç—Ä–∞ 09:15", datetime(2026, 2, 10, 9, 15, tzinfo=MOSCOW_TZ)),
        ("  —Å–µ–≥–æ–¥–Ω—è  07:00  ", datetime(2026, 2, 9, 7, 0, tzinfo=MOSCOW_TZ)),  # —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
        ("–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ", None),
        ("—Å–µ–≥–æ–¥–Ω—è abc", None),
        ("–∑–∞–≤—Ç—Ä–∞ 25:00", None),
    ]
)
def test_parse_datetime(text, expected):
    """
    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ parse_datetime.

    –§—É–Ω–∫—Ü–∏—è parse_datetime –¥–æ–ª–∂–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ
    –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ –æ–±—ä–µ–∫—Ç datetime —Å —É—á—ë—Ç–æ–º —Å–ª–æ–≤
    '—Å–µ–≥–æ–¥–Ω—è' –∏ '–∑–∞–≤—Ç—Ä–∞', –∞ —Ç–∞–∫–∂–µ —Å—Ç—Ä–æ–≥–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ YYYY-MM-DD HH:MM.
    –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None.

    –®–∞–≥–∏ —Ç–µ—Å—Ç–∞:
    1. –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã (text)
    2. –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é parse_datetime
    3. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –æ–∂–∏–¥–∞–µ–º—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º (expected)
       - –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å datetime —Å tzinfo –∏–ª–∏ None
    """
    # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é parse_datetime –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–∫—Å—Ç–∞
    dt = parse_datetime(text)

    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –æ–∂–∏–¥–∞–µ–º—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
    assert dt == expected


# -------------------------------------------------------------------
# –¢–µ—Å—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ format_task_date —Å datetime
# -------------------------------------------------------------------
@freeze_time("2026-02-09 12:00:00", tz_offset=3)
def test_format_task_date_datetime():
    """
    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ format_task_date —Å –æ–±—ä–µ–∫—Ç–æ–º datetime.

    –§—É–Ω–∫—Ü–∏—è format_task_date –¥–æ–ª–∂–Ω–∞:
    - –ø—Ä–∏–Ω–∏–º–∞—Ç—å datetime —Å tzinfo
    - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –≤ –º–æ—Å–∫–æ–≤—Å–∫–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å (UTC+3)
    - –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä–æ–∫—É —Ñ–æ—Ä–º–∞—Ç–∞ "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏, DD –ú–µ—Å—è—Ü YYYY HH:MM" –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

    –®–∞–≥–∏ —Ç–µ—Å—Ç–∞:
    1. –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç datetime –≤ UTC
    2. –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é format_task_date
    3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –∏ –º–µ—Å—è—Ü –Ω–∞ —Ä—É—Å—Å–∫–æ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    4. –§–æ—Ä–º–∏—Ä—É–µ–º –æ–∂–∏–¥–∞–µ–º—É—é —Å—Ç—Ä–æ–∫—É —Å —É—á–µ—Ç–æ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ
    5. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —Å –æ–∂–∏–¥–∞–µ–º—ã–º
    """
    # –°–æ–∑–¥–∞–µ–º datetime —Å tzinfo=UTC
    dt = datetime(2026, 2, 9, 15, 30, tzinfo=timezone.utc)

    # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    result = format_task_date(dt)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º –ø–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    day_name = RU_DAYS[dt.astimezone(MOSCOW_TZ).weekday()]

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    month_name = RU_MONTHS[dt.astimezone(MOSCOW_TZ).month - 1]

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–∂–∏–¥–∞–µ–º—É—é —Å—Ç—Ä–æ–∫—É —Å —É—á–µ—Ç–æ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ UTC->Moscow (15:30+3=18:30)
    expected = f"{day_name}, 09 {month_name} 2026 18:30"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å –æ–∂–∏–¥–∞–µ–º—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
    assert result == expected


# -------------------------------------------------------------------
# –¢–µ—Å—Ç—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ format_task_date —Å ISO-—Å—Ç—Ä–æ–∫–æ–π
# -------------------------------------------------------------------
def test_format_task_date_iso_string():
    """
    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ format_task_date —Å ISO-—Å—Ç—Ä–æ–∫–æ–π.

    –§—É–Ω–∫—Ü–∏—è format_task_date –¥–æ–ª–∂–Ω–∞:
    - –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å—Ç—Ä–æ–∫—É –≤ ISO-—Ñ–æ—Ä–º–∞—Ç–µ, –≤–∫–ª—é—á–∞—è —Å—É—Ñ—Ñ–∏–∫—Å "Z" (UTC)
    - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –≤ datetime
    - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è (UTC+3)
    - –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä–æ–∫—É —Ñ–æ—Ä–º–∞—Ç–∞ "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏, DD –ú–µ—Å—è—Ü YYYY HH:MM" –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

    –®–∞–≥–∏ —Ç–µ—Å—Ç–∞:
    1. –ü–µ—Ä–µ–¥–∞–µ–º ISO-—Å—Ç—Ä–æ–∫—É —Å "Z" –¥–ª—è UTC
    2. –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é format_task_date
    3. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ISO-—Å—Ç—Ä–æ–∫—É –≤—Ä—É—á–Ω—É—é –≤ datetime –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    4. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –∏ –º–µ—Å—è—Ü –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    5. –§–æ—Ä–º–∏—Ä—É–µ–º –æ–∂–∏–¥–∞–µ–º—É—é —Å—Ç—Ä–æ–∫—É
    6. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —Å –æ–∂–∏–¥–∞–µ–º—ã–º
    """
    # ISO-—Å—Ç—Ä–æ–∫–∞ —Å UTC –≤—Ä–µ–º–µ–Ω–µ–º
    iso_str = "2026-02-10T12:00:00Z"

    # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    result = format_task_date(iso_str)

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ISO-—Å—Ç—Ä–æ–∫—É –≤ datetime –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    dt = datetime.fromisoformat(iso_str.replace("Z", "+00:00")).astimezone(MOSCOW_TZ)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    day_name = RU_DAYS[dt.weekday()]

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    month_name = RU_MONTHS[dt.month - 1]

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–∂–∏–¥–∞–µ–º—É—é —Å—Ç—Ä–æ–∫—É —Å —É—á–µ—Ç–æ–º –ø–µ—Ä–µ–≤–æ–¥–∞ UTC->Moscow (12:00+3=15:00)
    expected = f"{day_name}, 10 {month_name} 2026 15:00"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –æ–∂–∏–¥–∞–µ–º—ã–º
    assert result == expected



# -------------------------------------------------------------------
# –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ format_task_date —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º —Ç–∏–ø–æ–º
# -------------------------------------------------------------------
def test_format_task_date_invalid_type():
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –≤ format_task_date.

    –§—É–Ω–∫—Ü–∏—è format_task_date –¥–æ–ª–∂–Ω–∞ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–æ–ª—å–∫–æ:
    - datetime
    - —Å—Ç—Ä–æ–∫—É –≤ ISO-—Ñ–æ—Ä–º–∞—Ç–µ

    –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ç–∏–ø (–Ω–∞–ø—Ä–∏–º–µ—Ä, int), –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å
    –≤—ã–∑–≤–∞–Ω–∞ –æ—à–∏–±–∫–∞ TypeError.

    –®–∞–≥–∏ —Ç–µ—Å—Ç–∞:
    1. –ü–µ—Ä–µ–¥–∞–µ–º —á–∏—Å–ª–æ 12345 –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞
    2. –ò—Å–ø–æ–ª—å–∑—É–µ–º pytest.raises –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ TypeError
    3. –¢–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    """
    import pytest  # –∏–º–ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–¥–∞—á–∞ int –≤—ã–∑—ã–≤–∞–µ—Ç TypeError
    with pytest.raises(TypeError):
        format_task_date(12345)  # type: ignore


# -------------------------------------------------------------------
# –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ format_task
# -------------------------------------------------------------------
def test_format_task():
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

    –§—É–Ω–∫—Ü–∏—è format_task –¥–æ–ª–∂–Ω–∞:
    - –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–ª–æ–≤–∞—Ä—å —Å –∫–ª—é—á–∞–º–∏ 'title' –∏ 'scheduled_time'
    - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å format_task_date –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ —á–∏—Ç–∞–µ–º—É—é —Å—Ç—Ä–æ–∫—É
    - –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞:
      "üìù {title}\n‚è∞ {–¥–∞—Ç–∞ –≤ —á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ}"

    –®–∞–≥–∏ —Ç–µ—Å—Ç–∞:
    1. –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –∑–∞–¥–∞—á–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ –≤—Ä–µ–º–µ–Ω–µ–º –≤ UTC
    2. –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é format_task
    3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π
       (—Ç.–∫. —Ç–æ—á–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ–∂–∏–¥–∞–µ–º–æ–π —Å—Ç—Ä–æ–∫–æ–π –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ)
    """
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–º–µ—Ä –∑–∞–¥–∞—á–∏
    task = {
        "title": "–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞",
        "scheduled_time": datetime(2026, 2, 10, 12, 0, tzinfo=timezone.utc)
    }

    # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
    result = format_task(task)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    assert result == result  # –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç: —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –ª–æ–º–∞–µ—Ç—Å—è


# –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ format_task_date —Å "–Ω–∞–∏–≤–Ω—ã–º" datetime (–±–µ–∑ tzinfo)
def test_format_task_date_naive_datetime():
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è "–Ω–∞–∏–≤–Ω–æ–≥–æ" datetime (–±–µ–∑ tzinfo) –≤ format_task_date.

    –§—É–Ω–∫—Ü–∏—è format_task_date –¥–æ–ª–∂–Ω–∞:
    - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, —á—Ç–æ datetime –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç tzinfo
    - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å UTC –∫–∞–∫ –±–∞–∑–æ–≤—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
    - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –≤ –ú–æ—Å–∫–æ–≤—Å–∫–∏–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å (UTC+3)
    - –≤–µ—Ä–Ω—É—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É —Å –¥–Ω–µ–º –Ω–µ–¥–µ–ª–∏, –º–µ—Å—è—Ü–µ–º –∏ –≤—Ä–µ–º–µ–Ω–µ–º

    –®–∞–≥–∏ —Ç–µ—Å—Ç–∞:
    1. –°–æ–∑–¥–∞–µ–º datetime –±–µ–∑ tzinfo
    2. –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é format_task_date
    3. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è –≤ UTC –∏ –∑–∞—Ç–µ–º –≤ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    4. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∂–∏–¥–∞–µ–º—ã–π —á–∞—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–∂–∏–¥–∞–µ–º—ã–π —á–∞—Å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏
    """
    # –°–æ–∑–¥–∞–µ–º –Ω–∞–∏–≤–Ω—ã–π datetime –±–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ
    dt = datetime(2026, 2, 9, 12, 0)  # –Ω–µ—Ç tzinfo

    # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    result = format_task_date(dt)

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–∏–≤–Ω—ã–π datetime –≤ UTC –∏ –∑–∞—Ç–µ–º –≤ –ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è
    expected_hour = (dt.replace(tzinfo=timezone.utc).astimezone(MOSCOW_TZ)).hour

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á–∞—Å —Å —É—á–µ—Ç–æ–º UTC+3 –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
    assert str(expected_hour).zfill(2) in result


# –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ parse_and_validate_datetime
@pytest.mark.parametrize(
    "text,expected",
    [
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ "–∑–∞–≤—Ç—Ä–∞ 14:00"
        # –û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω–µ—Ç datetime –≤ UTC –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
        ("–∑–∞–≤—Ç—Ä–∞ 14:00", (datetime.now() + timedelta(days=1)).replace(
            day=datetime.now().day + 1,  # –¥–µ–Ω—å –∑–∞–≤—Ç—Ä–∞—à–Ω–∏–π
            hour=11,  # 14:00 –ø–æ –ú–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ = 11:00 UTC
            minute=0,
            second=0,
            microsecond=0,
            tzinfo=timezone.utc
        )),
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ "—Å–µ–≥–æ–¥–Ω—è 23:59"
        # –û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω–µ—Ç datetime –≤ UTC —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
        ("—Å–µ–≥–æ–¥–Ω—è 23:59", datetime.now().replace(
            hour=20,  # 23:59 –ø–æ –ú–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ = 20:59 UTC
            minute=59,
            second=0,
            microsecond=0,
            tzinfo=timezone.utc
        )),
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ –ø—Ä–æ—à–ª–æ–º
        # –û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω–µ—Ç None, —Ç–∞–∫ –∫–∞–∫ –¥–∞—Ç–∞ —É–∂–µ –ø—Ä–æ—à–ª–∞
        ("2026-02-08 15:00", None),
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫–∏
        # –û–∂–∏–¥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω–µ—Ç None
        ("–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ", None)
    ]
)
def test_parse_and_validate_datetime(text, expected):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏ parse_and_validate_datetime.

    –§—É–Ω–∫—Ü–∏—è parse_and_validate_datetime –¥–æ–ª–∂–Ω–∞:
    - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ ("—Å–µ–≥–æ–¥–Ω—è", "–∑–∞–≤—Ç—Ä–∞", —Å—Ç—Ä–æ–≥–∏–π —Ñ–æ—Ä–º–∞—Ç)
    - –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å datetime –≤ UTC
    - –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –¥–∞—Ç–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –±—É–¥—É—â–µ–º, –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å None –¥–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö –¥–∞—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Å—Ç—Ä–æ–∫

    –®–∞–≥–∏ —Ç–µ—Å—Ç–∞:
    1. –ò—Å–ø–æ–ª—å–∑—É–µ–º parametrize –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:
       - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ "–∑–∞–≤—Ç—Ä–∞"
       - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ "—Å–µ–≥–æ–¥–Ω—è"
       - –¥–∞—Ç–∞ –≤ –ø—Ä–æ—à–ª–æ–º
       - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
    2. –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –≤—ã–∑—ã–≤–∞–µ–º parse_and_validate_datetime
    3. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –æ–∂–∏–¥–∞–µ–º—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º (datetime –≤ UTC –∏–ª–∏ None)
    4. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±—É–¥—É—â–∏–µ –∏ –ø—Ä–æ—à–µ–¥—à–∏–µ –¥–∞—Ç—ã
    5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö

    Args:
        text (str): –í—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞—Ç–æ–π/–≤—Ä–µ–º–µ–Ω–µ–º
        expected (datetime | None): –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ UTC –∏–ª–∏ None

    Returns:
        None: –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç assert –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    """
    # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞—Ç—ã
    dt_utc = parse_and_validate_datetime(text)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
    assert dt_utc == expected
